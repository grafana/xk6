package lint

import (
	"context"
	"errors"
	"os/exec"
)

const govulncheckName = "govulncheck"

func checkerVulnerability(ctx context.Context, dir string) *checkResult {
	_, err := exec.LookPath(gosecName)
	if err != nil {
		return checkFailed("the 'govulncheck' tool is missing")
	}

	cmd := exec.CommandContext( // #nosec G204
		ctx,
		govulncheckName,
		"-C", dir,
		"./...",
	)

	err = cmd.Run()
	if err == nil {
		return checkPassed("no issues found")
	}

	var exiterr *exec.ExitError

	const exitFound = 3

	if errors.As(err, &exiterr) && exiterr.ExitCode() == exitFound {
		return checkFailed("issue was found")
	}

	return checkError(err)
}
